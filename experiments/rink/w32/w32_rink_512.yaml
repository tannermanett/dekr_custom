# =========================
# DEKR HRNet-W32 (Rink-56)
# Small dataset (≈1,200 imgs)
# =========================

AUTO_RESUME: True
DATA_DIR: ''
GPUS: (0,)
LOG_DIR: log
OUTPUT_DIR: output
PRINT_FREQ: 100
VERBOSE: False

CUDNN:
  BENCHMARK: True
  DETERMINISTIC: False
  ENABLED: True

DATASET:
  # COCO-style keypoint loader; plain JPGs in folders
  DATASET: coco_kpt
  DATASET_TEST: coco_kpt
  DATA_FORMAT: jpg

  # ---- Augmentation (rink-aware) ----
  # Flip off: no true L/R symmetry across the rink template
  FLIP: 0.0
  INPUT_SIZE: 512
  OUTPUT_SIZE: 128
  MAX_NUM_PEOPLE: 3
  # Slightly tighter than generic DEKR to reflect broadcast pans/zooms
  MAX_ROTATION: 20        # was 30
  SCALE_TYPE: 'short'
  MIN_SCALE: 0.8          # was 0.75
  MAX_SCALE: 1.4          # was 1.5
  MAX_TRANSLATE: 40

  NUM_JOINTS: 56          # rink-56
  ROOT: 'data/rink'       # contains train2017/ val2017 + annotations
  TEST: val2017
  TRAIN: train2017

  # Heatmap/offset target settings
  OFFSET_RADIUS: 4
  SIGMA: 2.0
  CENTER_SIGMA: 4.0
  BG_WEIGHT: 0.1

LOSS:
  WITH_HEATMAPS_LOSS: True
  HEATMAPS_LOSS_FACTOR: 1.0
  WITH_OFFSETS_LOSS: True
  OFFSETS_LOSS_FACTOR: 0.03   # can bump to 0.04–0.05 late if offsets lag

MODEL:
  NAME: hrnet_dekr
  INIT_WEIGHTS: True
  NUM_JOINTS: 56
  PRETRAINED: 'model/imagenet/hrnet_w32-36af842e.pth'

  SPEC:
    FINAL_CONV_KERNEL: 1
    PRETRAINED_LAYERS: ['*']
    STAGES:
      NUM_STAGES: 3
      NUM_MODULES: [1, 4, 3]
      NUM_BRANCHES: [2, 3, 4]
      BLOCK: [BASIC, BASIC, BASIC]
      NUM_BLOCKS:
        - [4, 4]
        - [4, 4, 4]
        - [4, 4, 4, 4]
      NUM_CHANNELS:
        - [32, 64]
        - [32, 64, 128]
        - [32, 64, 128, 256]
      FUSE_METHOD: [SUM, SUM, SUM]

    HEAD_HEATMAP:
      BLOCK: BASIC
      NUM_BLOCKS: 1
      NUM_CHANNELS: 32
      DILATION_RATE: 1

    HEAD_OFFSET:
      BLOCK: ADAPTIVE
      NUM_BLOCKS: 2
      NUM_CHANNELS_PERKPT: 15
      DILATION_RATE: 1

TEST:
  FLIP_TEST: False
  IMAGES_PER_GPU: 1
  MODEL_FILE: ''
  SCALE_FACTOR: [1]
  NMS_THRE: 0.05
  NMS_NUM_THRE: 8
  KEYPOINT_THRESHOLD: 0.01
  ADJUST_THRESHOLD: 0.05
  MAX_ABSORB_DISTANCE: 75
  GUASSIAN_KERNEL: 6
  DECREASE: 0.9

RESCORE:
  VALID: False

TRAIN:
  BEGIN_EPOCH: 0
  CHECKPOINT: ''
  # ---- Extended small-dataset schedule ----
  END_EPOCH: 200           # was 140; gives heads time to converge
  LR: 0.001
  LR_FACTOR: 0.1
  LR_STEP: [120, 170]      # at ~60% and ~85% of total epochs
  OPTIMIZER: adam
  MOMENTUM: 0.9            # ignored by Adam but harmless in config
  NESTEROV: False
  GAMMA1: 0.99
  GAMMA2: 0.0
  IMAGES_PER_GPU: 6        # try 8 if VRAM allows; keep 6 for safety
  WD: 0.0001
  RESUME: False
  SHUFFLE: True

WORKERS: 4
